import type { Vulnerability } from '@/type';
import { exportHandler, selectedRecordForExport } from '@/utils/exportToCSVFile';
import { Checkbox, Table } from '@mantine/core';
import Link from 'next/link';
import { useRouter } from 'next/router';
import React, { useState } from 'react';
import { useEffect } from 'react';

type VulnerabilityListProps = {
  vulnerabilities: Vulnerability[];
};

const onClickHandler = (vulnerability: Vulnerability) => {
  const queryString = new URLSearchParams(vulnerability).toString();

  window.location.href = `/vulnerability?${queryString}`;
};
const VulnerabilityList: React.FC<VulnerabilityListProps> = ({
  vulnerabilities,
}) => {
  const [vulnerabilityList, setVulnerabilityList] =
    useState<Vulnerability[]>(vulnerabilities);
  const [checked, setChecked] = useState<string[]>([]);
  const router = useRouter();
  const { query } = router;
  const sortKey = query.sort as keyof Vulnerability;

  useEffect(() => {
    if (sortKey) {
      sortVulnerabilities(sortKey);
    }
  }, [sortKey]);
  const sortVulnerabilities = (key: keyof Vulnerability) => {
    const sortedVulnerabilities = [...vulnerabilityList].sort((a, b) => {
      if (a[key] < b[key]) return -1;
      if (a[key] > b[key]) return 1;
      return 0;
    });
    setVulnerabilityList(sortedVulnerabilities);
  };

  const handleSort = (key: keyof Vulnerability) => {
    router.push({
      query: { ...query, sort: key },
    });
  };
  const toggleCheckBoxHandler = (oid: string) => {
    if (checked.includes(oid)) {
      setChecked(checked.filter((item) => item !== oid));
    } else {
      setChecked([...checked, oid]);
    }
  };

  return (
    <div>
      <button
        onClick={() =>
          exportHandler(
            selectedRecordForExport(vulnerabilityList, checked),
            'Vulnerabilities'
          )
        }
      >
        Export to CSV
      </button>
      <Table>
        <Table.Thead>
          <Table.Tr>
            <Table.Th></Table.Th>
            <Table.Th onClick={() => handleSort('oid')}>Oid</Table.Th>
            <Table.Th onClick={() => handleSort('name')}>Name</Table.Th>
            <Table.Th onClick={() => handleSort('severity')}>Severity</Table.Th>
            <Table.Th onClick={() => handleSort('assetId')}>AssetId</Table.Th>
            <Table.Th onClick={() => handleSort('qod')}>Qod</Table.Th>
            <Table.Th onClick={() => handleSort('solutionType')}>SolutionType</Table.Th>
          </Table.Tr>
        </Table.Thead>
        <Table.Tbody>
          {vulnerabilityList.map((vulnerability) => (
            <Table.Tr key={vulnerability.oid}>
              <Table.Td>
                <Checkbox
                  checked={checked.includes(vulnerability.oid)}
                  onChange={() => toggleCheckBoxHandler(vulnerability.oid)}
                />
              </Table.Td>
              <Table.Td>{vulnerability.oid}</Table.Td>
              <Table.Td>{vulnerability.name}</Table.Td>
              <Table.Td>{vulnerability.severity}</Table.Td>
              <Table.Td>{vulnerability.assetId}</Table.Td>
              <Table.Td>{vulnerability.qod}</Table.Td>
              <Table.Td>{vulnerability.solutionType}</Table.Td>
              <Table.Td onClick={() => onClickHandler(vulnerability)}>
                <Link href="">Show Details</Link>
              </Table.Td>
            </Table.Tr>
          ))}
        </Table.Tbody>
      </Table>
    </div>
  );
};

export default VulnerabilityList;
